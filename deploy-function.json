{
  "name": "extract-beo",
  "slug": "extract-beo",
  "verify_jwt": true,
  "files": [
    {
      "name": "index.ts",
      "content": "import \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\nimport { createClient } from \"npm:@supabase/supabase-js@2.57.4\";\n\nconst corsHeaders = {\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\n  \"Access-Control-Allow-Headers\": \"Content-Type, Authorization, X-Client-Info, Apikey\",\n};\n\ninterface ExtractedBEOData {\n  eventName: string;\n  date: string;\n  venue: string;\n  guestCount: number;\n  startTime: string;\n  endTime: string;\n}\n\nDeno.serve(async (req: Request) => {\n  if (req.method === \"OPTIONS\") {\n    return new Response(null, {\n      status: 200,\n      headers: corsHeaders,\n    });\n  }\n\n  try {\n    const authHeader = req.headers.get(\"Authorization\");\n    if (!authHeader) {\n      return new Response(\n        JSON.stringify({ error: \"Missing authorization header\" }),\n        { status: 401, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const supabase = createClient(\n      Deno.env.get(\"SUPABASE_URL\") ?? \"\",\n      Deno.env.get(\"SUPABASE_ANON_KEY\") ?? \"\",\n      {\n        global: {\n          headers: { Authorization: authHeader },\n        },\n      }\n    );\n\n    const { data: { user }, error: userError } = await supabase.auth.getUser();\n    if (userError || !user) {\n      console.error(\"Auth error:\", userError);\n      return new Response(\n        JSON.stringify({ error: \"Unauthorized - please log in again\" }),\n        { status: 401, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const { data: profile, error: profileError } = await supabase\n      .from(\"profiles\")\n      .select(\"role\")\n      .eq(\"id\", user.id)\n      .maybeSingle();\n\n    if (profileError) {\n      console.error(\"Profile error:\", profileError);\n      return new Response(\n        JSON.stringify({ error: \"Failed to verify user permissions\" }),\n        { status: 500, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    if (!profile) {\n      console.error(\"No profile found for user:\", user.id);\n      return new Response(\n        JSON.stringify({ error: \"User profile not found. Please contact support.\" }),\n        { status: 404, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    if (profile.role !== \"admin\") {\n      return new Response(\n        JSON.stringify({ error: \"Only admins can upload BEO documents\" }),\n        { status: 403, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const formData = await req.formData();\n    const file = formData.get(\"file\") as File;\n\n    if (!file) {\n      return new Response(\n        JSON.stringify({ error: \"No file provided\" }),\n        { status: 400, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const allowedTypes = [\"application/pdf\", \"image/jpeg\", \"image/jpg\", \"image/png\"];\n    if (!allowedTypes.includes(file.type)) {\n      return new Response(\n        JSON.stringify({ error: \"File must be PDF or JPG/PNG\" }),\n        { status: 400, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const arrayBuffer = await file.arrayBuffer();\n    const bytes = new Uint8Array(arrayBuffer);\n    let base64 = '';\n    const chunkSize = 0x8000;\n    for (let i = 0; i < bytes.length; i += chunkSize) {\n      const chunk = bytes.subarray(i, Math.min(i + chunkSize, bytes.length));\n      base64 += String.fromCharCode(...chunk);\n    }\n    base64 = btoa(base64);\n    const mediaType = file.type;\n\n    const anthropicApiKey = Deno.env.get(\"ANTHROPIC_API_KEY\");\n    if (!anthropicApiKey) {\n      console.error(\"ANTHROPIC_API_KEY not found in environment\");\n      return new Response(\n        JSON.stringify({ error: \"AI service not configured. Please contact your administrator.\" }),\n        { status: 500, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const content: any[] = [];\n\n    if (file.type === \"application/pdf\") {\n      content.push({\n        type: \"document\",\n        source: {\n          type: \"base64\",\n          media_type: \"application/pdf\",\n          data: base64,\n        },\n      });\n    } else {\n      content.push({\n        type: \"image\",\n        source: {\n          type: \"base64\",\n          media_type: mediaType,\n          data: base64,\n        },\n      });\n    }\n\n    content.push({\n      type: \"text\",\n      text: \"Extract the following information from this Banquet Event Order (BEO) document and return it as JSON:\\n\\n- eventName: The name of the event\\n- date: The event date in YYYY-MM-DD format\\n- venue: The venue/room name\\n- guestCount: Estimated number of guests (as a number)\\n- startTime: Event start time in HH:MM format (24-hour)\\n- endTime: Event end time in HH:MM format (24-hour)\\n\\nReturn ONLY valid JSON with these exact field names. If you cannot find a field, use reasonable defaults: empty string for text fields, 0 for guestCount, and 00:00 for times.\",\n    });\n\n    console.log(\"Calling Claude API...\");\n    const claudeResponse = await fetch(\"https://api.anthropic.com/v1/messages\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"x-api-key\": anthropicApiKey,\n        \"anthropic-version\": \"2023-06-01\",\n      },\n      body: JSON.stringify({\n        model: \"claude-3-5-sonnet-20241022\",\n        max_tokens: 2048,\n        messages: [\n          {\n            role: \"user\",\n            content,\n          },\n        ],\n      }),\n    });\n\n    if (!claudeResponse.ok) {\n      const errorText = await claudeResponse.text();\n      console.error(\"Claude API error status:\", claudeResponse.status);\n      console.error(\"Claude API error:\", errorText);\n      return new Response(\n        JSON.stringify({\n          error: `AI extraction failed: ${claudeResponse.status}. Please try again or contact support.`,\n          details: errorText.substring(0, 200),\n        }),\n        { status: 500, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const claudeData = await claudeResponse.json();\n    console.log(\"Claude response received\");\n    const extractedText = claudeData.content[0].text;\n    console.log(\"Extracted text:\", extractedText.substring(0, 200));\n\n    let beoData: ExtractedBEOData;\n    try {\n      const jsonMatch = extractedText.match(/\\{[\\\\s\\\\S]*\\}/);\n      if (jsonMatch) {\n        beoData = JSON.parse(jsonMatch[0]);\n      } else {\n        beoData = JSON.parse(extractedText);\n      }\n      console.log(\"Successfully parsed BEO data:\", beoData);\n    } catch (parseError) {\n      console.error(\"Failed to parse Claude response:\", extractedText);\n      console.error(\"Parse error:\", parseError);\n      return new Response(\n        JSON.stringify({\n          error: \"Failed to parse extracted data from the document\",\n          details: extractedText.substring(0, 200),\n        }),\n        { status: 500, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const { data: draftEvent, error: eventError } = await supabase\n      .from(\"events\")\n      .insert({\n        title: beoData.eventName || \"Untitled Event\",\n        event_date: beoData.date || new Date().toISOString().split('T')[0],\n        venue: beoData.venue || \"TBD\",\n        start_time: beoData.startTime || \"00:00\",\n        end_time: beoData.endTime || \"00:00\",\n        open_shifts: Math.ceil(beoData.guestCount / 50) || 5,\n        status: \"draft\",\n        beo_source: file.name,\n        created_by: user.id,\n      })\n      .select()\n      .single();\n\n    if (eventError) {\n      console.error(\"Failed to create draft event:\", eventError);\n      return new Response(\n        JSON.stringify({ error: \"Failed to create draft event\" }),\n        { status: 500, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    return new Response(\n      JSON.stringify({\n        success: true,\n        extractedData: beoData,\n        draftEvent,\n      }),\n      {\n        status: 200,\n        headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\n      }\n    );\n  } catch (error) {\n    console.error(\"Error in extract-beo function:\", error);\n    return new Response(\n      JSON.stringify({ error: \"Internal server error\" }),\n      { status: 500, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n    );\n  }\n});"
    }
  ]
}
